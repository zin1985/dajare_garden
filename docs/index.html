!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒ€ã‚¸ãƒ£ãƒ¬ãƒãƒˆãƒ«é“å ´</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:system-ui, sans-serif;margin:2rem;max-width:720px}
h1{font-size:1.7rem}
input,textarea,button{font:inherit}
label{display:block;margin:0.5rem 0 0.2rem}
#rank ol{padding-left:1.2rem}
#msg{color:#d00}
</style>
</head>
<body>

<h1>ãƒ€ã‚¸ãƒ£ãƒ¬ãƒãƒˆãƒ«é“å ´ ğŸ†</h1>

<!-- â˜… ãƒ€ã‚¸ãƒ£ãƒ¬æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  ------------------------------- -->
<form id="punForm">
  <label>åå‰
    <input type="text" id="name" required>
  </label>
  <label>ãƒ€ã‚¸ãƒ£ãƒ¬ï¼ˆ400å­—ä»¥å†…ï¼‰
    <textarea id="pun" rows="4" maxlength="400" required></textarea>
  </label>
  <button type="submit">æŠ•ç¨¿ã—ã¦æ¡ç‚¹ã—ã¦ã‚‚ã‚‰ã†</button>
  <span id="msg"></span>
</form>
<hr>

<!-- â–¼ æ—¥ä»˜åˆ‡æ›¿ãƒ•ã‚©ãƒ¼ãƒ  & ä»Šæ—¥ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚° ------------------- -->
<form id="dateForm" style="margin-bottom:1rem;">
  <label>è¡¨ç¤ºæ—¥ä»˜ï¼š
    <input type="date" id="dateSel">
  </label>
  <button type="submit">è¡¨ç¤º</button>
</form>

<h2 id="titleDay"></h2>
<div id="rank">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

<script>
/* ===== ãƒªãƒã‚¸ãƒˆãƒª & ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®š ===== */
const OWNER = 'zin1985';
const REPO  = 'dajare_garden';

/* â†“ ãƒ‡ãƒ¢ç”¨ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ (public_repo scope æ¨å¥¨) */
const GH_TOKEN = 'ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';  // â˜…â˜… ç½®ãæ›ãˆ â˜…â˜…

/* ===== util: ä»Šæ—¥ or ?date=YYYY-MM-DD ===== */
const urlParams  = new URLSearchParams(location.search);
const today      = new Date();
const targetDate = urlParams.get('date') ? new Date(urlParams.get('date')) : today;
const yyyy = targetDate.getFullYear();
const mm   = String(targetDate.getMonth()+1).padStart(2,'0');
const dd   = String(targetDate.getDate()).padStart(2,'0');
document.getElementById('dateSel').value = `${yyyy}-${mm}-${dd}`;
document.getElementById('titleDay').textContent = `${yyyy}-${mm}-${dd} ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°`;

/* ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾— ===== */
async function loadRanking(){
  const url = `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/data/${yyyy}-${mm}-${dd}.json`;
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error(res.status);
    const rows = await res.json();
    rows.sort((a,b)=>Number(b.score)-Number(a.score));
    document.getElementById('rank').innerHTML =
      '<ol>'+rows.map(r=>`<li><strong>${r.score}ç‚¹</strong> ${r.name}ã€Œ${r.pun}ã€</li>`).join('')
      +'</ol>';
  }catch(e){
    document.getElementById('rank').textContent = 'ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“';
  }
}
loadRanking();

/* ===== æ—¥ä»˜åˆ‡æ›¿ ===== */
document.getElementById('dateForm').addEventListener('submit',e=>{
  e.preventDefault();
  const v=document.getElementById('dateSel').value;
  if(v) location.href=`?date=${v}`;
});

/* ===== ãƒ€ã‚¸ãƒ£ãƒ¬æŠ•ç¨¿ â†’ GitHub Issue ä½œæˆ ===== */
document.getElementById('punForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const pun  = document.getElementById('pun').value.trim();
  if(!name || !pun) return;

  const body = `### åå‰\n${name}\n\n### ãƒ€ã‚¸ãƒ£ãƒ¬\n${pun}`;
  const res  = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/issues`,{
    method:'POST',
    headers:{
      'Authorization':`token ${GH_TOKEN}`,
      'Accept':'application/vnd.github+json'
    },
    body: JSON.stringify({
      title:`[PUN] ${name}`,
      body,
      labels:['pun','user']
    })
  });

  const msgEl = document.getElementById('msg');
  if(res.ok){
    msgEl.textContent = 'ğŸ‰ æŠ•ç¨¿å®Œäº†ï¼æ¡ç‚¹çµæœãŒå‡ºã‚‹ã¾ã§æ•°åç§’ãŠå¾…ã¡ä¸‹ã•ã„ã€‚';
    msgEl.style.color = 'green';
    document.getElementById('pun').value='';
    setTimeout(loadRanking, 60_000);  // 1åˆ†å¾Œã«å†èª­è¾¼
  }else{
    const js = await res.json().catch(()=>{});
    msgEl.textContent = 'æŠ•ç¨¿å¤±æ•—: '+res.status+' '+(js?.message||'');
    msgEl.style.color = '#d00';
  }
});
</script>
</body>
</html>
